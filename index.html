<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Ticket Rush — PRO</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{
  color-scheme: dark;
  --bg:#0b1018; --panel:#0e1522; --panel2:#0a111c; --border:#223047;
  --text:#f3f7ff; --muted:#9fb0c9; --accent:#ffd54a;
  --ok:#35d08a; --bad:#ff5555;
  --coin:#ffd54a; --coinText:#1a2232; --bill1:#d6f0c9; --bill2:#b8e3aa;

  /* DUŻE UI */
  --baseH: 960px;
  --safe: 10px;

  --r-xl:26px; --r-lg:20px; --r-md:14px; --r-sm:10px;
  --gap:18px; --pad:20px;

  --h1:44px; --h2:30px; --h3:22px; --meta:17px;
  --tile:26px; --chip:18px;
}

*{box-sizing:border-box}
html{height:100dvh; -webkit-text-size-adjust:100%}
body{
  margin:0; height:100dvh; overflow:hidden; touch-action:manipulation;
  font-family:-apple-system,"SF Pro Text",Inter,system-ui,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 15% -10%, rgba(255,213,74,.12), transparent 60%),
    linear-gradient(#0a0f17,#0b1018);
  padding:
    calc(env(safe-area-inset-top) + var(--safe))
    calc(env(safe-area-inset-right) + var(--safe))
    calc(env(safe-area-inset-bottom) + var(--safe))
    calc(env(safe-area-inset-left) + var(--safe));
  -webkit-tap-highlight-color:transparent;
}

/* STAGE: centrowanie + skala */
#viewport{position:fixed; inset:0; overflow:hidden}
#stage{
  position:absolute; top:50%; left:50%;
  width:calc(var(--baseH) * (16/9)); height:var(--baseH);
  transform:translate(-50%,-50%) scale(var(--fit,1));
  transform-origin:center;
  filter: drop-shadow(0 22px 50px rgba(0,0,0,.44));
}

/* APLIKACJA */
.app{
  width:100%; height:100%;
  display:grid; grid-template-rows: 84px 120px 1fr 200px 150px;
  gap:var(--gap);
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  padding: calc(var(--gap) + 6px);
}

/* HEADER */
.header{display:grid; grid-template-columns: 1fr auto auto; gap:var(--gap); align-items:center}
.brand{display:flex; align-items:center; gap:14px; font-weight:900; font-size:var(--h1); letter-spacing:.02em}
.badge{background:var(--accent); color:#0c0f14; border-radius:999px; padding:6px 14px; font-weight:900}
.timer{font-weight:900; font-size:var(--h2); background:var(--accent); color:#0c0f14; padding:10px 16px; border-radius:14px}

/* HUD */
.hud{display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:var(--gap)}
.card{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--r-lg);
  padding:var(--pad); display:grid; gap:8px;
}
.meta{color:var(--muted); font-size:var(--meta); letter-spacing:.08em; text-transform:uppercase}
.big{font-size:var(--h2); font-weight:900}

/* TICKETS */
.tickets{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--r-lg); padding:var(--pad);
  display:grid; grid-template-rows: 46px 1fr; gap:var(--gap);
}
.tbar{display:flex; align-items:center; justify-content:space-between}
.clear{border:1px solid var(--border); background:#0f1828; color:#eaf1ff; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer}
.gridTickets{
  display:grid; gap:var(--gap);
  grid-template-columns:repeat(3,1fr);
  grid-auto-rows:minmax(120px,1fr);
}

/* Kafle biletów */
.btn{
  position:relative;
  display:grid; place-items:center; text-align:center; cursor:pointer; user-select:none;
  height:100%;
  border:0; border-radius:20px; color:#fff; padding:14px;
  font-weight:900; font-size:var(--tile); line-height:1.1;
  box-shadow: inset 0 -2px 0 rgba(255,255,255,.20), 0 12px 26px rgba(0,0,0,.32);
  transition:transform .06s ease, filter .12s ease, opacity .2s ease;
}
.btn:active{transform:translateY(1px) scale(.99)}
.btn:disabled{opacity:.42; cursor:not-allowed}
.sub{font-size:20px; font-weight:800; opacity:.97}
.bubble{
  position:absolute; top:10px; right:10px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.35);
  padding:4px 10px; border-radius:999px; font-size:var(--chip); font-weight:900
}

/* Kolory biletów */
.t-normal  {background:linear-gradient(140deg,#22c07a,#139a61)}
.t-kid     {background:linear-gradient(140deg,#4aa7ff,#2c7cff)}
.t-luggage {background:linear-gradient(140deg,#ff9650,#ff7828)}
.t-senior  {background:linear-gradient(140deg,#b995ff,#8a6eff)}
.t-disabled{background:linear-gradient(140deg,#ff6e9e,#e34a82)}
.t-stroller{background:linear-gradient(140deg,#42dede,#23bbbb)}
.t-bike    {background:linear-gradient(140deg,#a2e65a,#82cf35)}
.t-tourist {background:linear-gradient(140deg,#ff7167,#ff5348)}

/* PAYMENT */
.pay{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--r-lg); padding:var(--pad);
  display:grid; grid-template-rows: 46px 1fr; gap:var(--gap);
}
.pbar{display:flex; align-items:center; justify-content:space-between}
.remain{
  font-weight:900; font-size:var(--h2); padding:10px 14px; border-radius:14px;
  background:#0f1828; border:1px solid var(--border); min-width:150px; text-align:center;
}
.gridCoins{
  display:grid; gap:var(--gap);
  grid-template-columns:repeat(5,1fr); grid-auto-rows:minmax(110px,1fr);
}

/* monety i banknot */
.coin{
  border-radius:999px; color:var(--coinText);
  background:radial-gradient(circle at 30% 25%, #fff5b5 0%, var(--coin) 55%, #f0c63d 100%);
  border:3px solid #e8bf39;
}
.bill{
  border-radius:16px; color:#10311d;
  background:linear-gradient(180deg,var(--bill1),var(--bill2));
  border:3px solid #9fce8c;
}

/* HISTORIA */
.footer{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--r-lg);
  padding:var(--pad); display:grid; grid-template-rows: 22px 1fr; gap:12px;
}
.list{display:grid; gap:12px; grid-auto-rows:minmax(48px,auto); overflow:auto}
.item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px;
      background:#0b1220; border:1px solid var(--border)}
.badge{font-weight:900; padding:6px 10px; border-radius:999px; border:1px solid #2a3346; color:#d9e3f3}

/* OVERLAY (feedback / odliczanie / podsumowanie) */
.overlay{
  position:absolute; inset:0; display:none; place-items:center; background:rgba(8,12,20,.70);
  backdrop-filter: blur(6px); z-index:20;
}
.overlay.show{display:grid}
.box{
  background:#0b1220; border:1px solid var(--border); border-radius:20px; padding:28px 32px;
  text-align:center; width:min(92vw, 800px);
}
.title{font-size:38px; font-weight:900; margin-bottom:10px}
.count{font-size:32px; font-weight:900; color:var(--accent)}
.small{color:var(--muted); font-size:18px}
.points{font-size:34px; font-weight:900; margin:10px 0}
.good{color:var(--ok)} .bad{color:var(--bad)}
.summary-list{display:grid; gap:10px; margin-top:14px; max-height:52vh; overflow:auto; text-align:left}
.s-item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; background:#0b1220; border:1px solid var(--border)}
.btn-cta{margin-top:18px; padding:12px 18px; border-radius:12px; border:1px solid var(--border); background:#0f1828; color:#fff; font-weight:900; cursor:pointer}
</style>
</head>
<body>
  <div id="viewport">
    <div id="stage">
      <div class="app">
        <!-- HEADER -->
        <div class="header">
          <div class="brand">🚌 Ticket Rush <span class="badge">PRO</span></div>
          <div class="card"><div class="meta">Score</div><div class="big" id="score">0</div></div>
          <div class="timer" id="timer">20 s</div>
        </div>

        <!-- HUD -->
        <div class="hud">
          <div class="card">
            <div class="meta">Passenger needs</div>
            <div class="big" id="need">—</div>
          </div>
          <div class="card"><div class="meta">To pay</div><div class="big" id="pays">$0.00</div></div>
          <div class="card"><div class="meta">Tickets value</div><div class="big" id="fare">$0.00</div></div>
          <div class="card"><div class="meta">Selected value</div><div class="big" id="picked">$0.00</div></div>
        </div>

        <!-- TICKETS -->
        <section class="tickets">
          <div class="tbar">
            <div class="meta">Tickets</div>
            <button class="clear" id="clearTickets">Clear</button>
          </div>
          <div class="gridTickets" id="tickets"></div>
        </section>

        <!-- PAYMENT -->
        <section class="pay">
          <div class="pbar">
            <div class="meta">Change</div>
            <div class="remain" id="remain">$?</div>
          </div>
          <div class="gridCoins" id="coins"></div>
        </section>

        <!-- HISTORY -->
        <section class="footer">
          <div class="meta">History</div>
          <div class="list" id="history"></div>
        </section>
      </div>

      <!-- OVERLAY (dynamic) -->
      <div class="overlay" id="overlay">
        <div class="box" id="overlayBox">
          <!-- dynamic content -->
        </div>
      </div>
    </div>
  </div>

<script>
/* Anti-zoom iOS */
(function(){let t=0;document.addEventListener('touchend',e=>{const n=Date.now();if(n-t<350){e.preventDefault()}t=n},{passive:false});document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false})})();

/* Fit-to-screen */
(function(){
  const stage=document.getElementById('stage');
  function fit(){
    const vv=window.visualViewport||{width:innerWidth,height:innerHeight};
    const vw=vv.width, vh=vv.height, baseH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--baseH'));
    const baseW=baseH*(vw/vh);
    stage.style.width=baseW+'px'; stage.style.height=baseH+'px';
    const scale=Math.min(vw/baseW, vh/baseH);
    stage.style.setProperty('--fit', scale);
  }
  addEventListener('resize',fit); addEventListener('orientationchange',()=>setTimeout(fit,60));
  document.fonts?.ready.then(fit); new ResizeObserver(fit).observe(document.getElementById('viewport')); fit();
})();

/* ===== GAME ===== */
const ALL_TICKETS=[
  {name:"Normal", price:1.2, cls:"t-normal"},
  {name:"Kid", price:0.5, cls:"t-kid"},
  {name:"Luggage", price:0.6, cls:"t-luggage"},
  {name:"Senior", price:0.8, cls:"t-senior"},
  {name:"Disabled", price:0.6, cls:"t-disabled"},
  {name:"Baby Stroller", price:0.7, cls:"t-stroller"},
  {name:"Bike", price:0.9, cls:"t-bike"},
  {name:"Tourist", price:1.5, cls:"t-tourist"}
];

const COINS=[5,2,1,0.5,0.25,0.1,0.05,0.01];

const $=id=>document.getElementById(id);
const timerDisplay=$("timer"), scoreDisplay=$("score"), historyList=$("history"),
  needEl=$("need"), paysEl=$("pays"), fareEl=$("fare"), pickedEl=$("picked"),
  remainEl=$("remain"), overlay=$("overlay"), overlayBox=$("overlayBox"),
  ticketsWrap=$("tickets"), coinsWrap=$("coins");

const TOTAL_ROUNDS=5;
let currentRound=0, score=0, timerId=null, overlayId=null;

/* zapamiętujemy rundy do końcowego podsumowania */
const roundSummaries=[];

const state={
  available:[],
  request:{},
  ticketTotal:0, pays:0,
  selectedTickets:{}, coinsUsed:{}, inserted:0,
  timeLeft:20, history:[],
  showChange:false
};

/* Losowanie “autobusu” */
function rollBusConfig(){
  const minTotal=2, maxTotal=6;
  const others=ALL_TICKETS.filter(t=>t.name!=="Normal" && t.name!=="Kid");
  const howMany = Math.floor(Math.random()*(maxTotal-minTotal+1))+minTotal;
  const shuffled = others.sort(()=>Math.random()-0.5);
  return [ALL_TICKETS.find(t=>t.name==="Normal"), ALL_TICKETS.find(t=>t.name==="Kid"), ...shuffled.slice(0,Math.max(0,howMany-2))];
}

/* Potrzeby pasażera */
function rollRequest(available){
  const pool=[...available];
  const uniq = Math.min(pool.length, Math.floor(Math.random()*2)+1); // 1–2 typy
  const out={};
  for(let i=0;i<uniq;i++){
    const pick=Math.floor(Math.random()*pool.length);
    const t=pool.splice(pick,1)[0];
    const cnt=Math.floor(Math.random()*3)+1; // 1–3 szt.
    out[t.name]=cnt;
  }
  return out;
}

const fareOf=req=>Object.entries(req).reduce((s,[n,c])=>{
  const t=ALL_TICKETS.find(x=>x.name===n); return s+(t?t.price*c:0)
},0);
const uniqCoins=()=>Object.keys(state.coinsUsed).filter(k=>state.coinsUsed[k]>0).length;

/* RENDER */
function renderTickets(){
  ticketsWrap.innerHTML = state.available.map(t=>{
    const count=state.selectedTickets[t.name]||0, need=state.request[t.name]||0, dis=(need>0 && count>=need);
    return `<button class="btn ${t.cls}" ${dis?'disabled':''}
              onclick="addTicket('${t.name}')" oncontextmenu="event.preventDefault(); removeTicket('${t.name}')">
              ${count?`<span class="bubble">×${count}</span>`:''}
              <div class="sub">${t.name}</div>
              <div>$${t.price.toFixed(2)}</div>
            </button>`;
  }).join("");
}
function renderCoins() {
  // bezpieczeństwo gdyby coś się nie zainicjalizowało
  if (!Array.isArray(COINS) || !coinsWrap) return;

  coinsWrap.innerHTML = COINS
    .map((v, i) => {
      return `
        <button class="btn ${i === 0 ? 'bill' : 'coin'}" onclick="insertCoin(${v})">
          <div class="sub">${i === 0 ? 'Bill' : 'Coin'}</div>
          <div>$${v.toFixed(2)}</div>
        </button>
      `;
    })
    .join("");
}

function updateHud() {
  scoreDisplay.textContent = String(score);

  // potrzeby pasażera
  const needTxt = Object.entries(state.request)
    .map(([n, c]) => `${c}× ${n}`)
    .join(", ");
  needEl.textContent = needTxt || "—";

  // wartości
  paysEl.textContent  = `$${state.pays.toFixed(2)}`;
  fareEl.textContent  = `$${state.ticketTotal.toFixed(2)}`;

  const selectedValue = Object.entries(state.selectedTickets).reduce((sum, [n, c]) => {
    const t = ALL_TICKETS.find(x => x.name === n);
    return sum + (t ? t.price * c : 0);
  }, 0);
  pickedEl.textContent = `$${selectedValue.toFixed(2)}`;

  // reszta — pokazuj dopiero po pierwszej monecie
  const changeDue = +(state.pays - state.ticketTotal).toFixed(2);
  const remaining = +(changeDue - state.inserted).toFixed(2);
  remainEl.textContent = state.showChange ? `$${Math.max(remaining, 0).toFixed(2)}` : "$?";

  // historia
  historyList.innerHTML = (state.history || [])
    .map(({ round: r, success, reason, bonuses }) => {
      const tags = (bonuses && bonuses.length)
        ? `<span class="badge">${bonuses.join(" • ")}</span>`
        : "";
      return `
        <div class="item">
          <span><strong>Round ${r}</strong> ${success ? "✅" : "❌"} ${reason || ""}</span>
          ${tags}
        </div>
      `;
    })
    .join("");
}

/* RUNDA */
function startRound(){
  currentRound+=1; if(currentRound> TOTAL_ROUNDS){showEndSummary(); return;}
  state.available = rollBusConfig();
  state.request = rollRequest(state.available);
  state.selectedTickets={}; state.coinsUsed={}; state.inserted=0; state.timeLeft=20; state.showChange=false;

  state.ticketTotal = +fareOf(state.request).toFixed(2);
  const extra=[0.5,1,1.5,2,2.5][Math.floor(Math.random()*5)];
  state.pays = +(state.ticketTotal+extra).toFixed(2);

  renderTickets(); renderCoins(); updateHud(); startTimer();
}
function startTimer(){ stopTimer(); timerDisplay.textContent=`${state.timeLeft} s`;
  timerId=setInterval(()=>{state.timeLeft--; if(state.timeLeft<=0){timerDisplay.textContent='0 s'; stopTimer(); done(false,{reason:"Time up"});return}
  timerDisplay.textContent=`${state.timeLeft} s`},1000)}
function stopTimer(){ if(timerId){clearInterval(timerId); timerId=null} }

/* OVERLAY UTILS */
function setOverlay(html){ overlayBox.innerHTML=html; overlay.classList.add('show'); }
function hideOverlay(){ overlay.classList.remove('show'); }

/* Quick feedback (1.2 s), potem odliczanie */
function showQuickFeedback(ok, delta, reason){
  const cls = ok?'good':'bad';
  setOverlay(`
    <div class="title ${cls}">${ok?'✅ OK':'❌ Error'}</div>
    <div class="points ${cls}">${delta>0?`+${delta}`:delta}</div>
    <div class="small">${reason || (ok?'Sale complete':'Issue with sale')}</div>
  `);
  setTimeout(()=>{ showCountdown(5); }, 1200);
}

/* Odliczanie do kolejnego pasażera */
function showCountdown(sec){
  let left=sec;
  setOverlay(`
    <div class="title">Next passenger in</div>
    <div class="count" id="countNum">${left}</div>
  `);
  overlayId=setInterval(()=>{
    left--; const el=document.getElementById('countNum'); if(el) el.textContent=left;
    if(left<=0){ clearInterval(overlayId); overlayId=null; hideOverlay(); startRound(); }
  },1000);
}

/* Koniec gry: podsumowanie 5 rund + „Play again” */
function showEndSummary(){
  const items = roundSummaries.map(r=>{
    const cls=r.success?'good':'bad';
    const delta = r.pointsDelta>0?`+${r.pointsDelta}`:r.pointsDelta;
    const need = Object.entries(r.request).map(([n,c])=>`${c}× ${n}`).join(", ");
    return `<div class="s-item">
      <span><strong class="${cls}">${r.success?'✅':'❌'}</strong> Round ${r.round} — ${need}</span>
      <span class="${cls}" style="font-weight:900">${delta}</span>
    </div>`;
  }).join("");
  setOverlay(`
    <div class="title">Shift complete</div>
    <div class="small">Final score</div>
    <div class="points">${score}</div>
    <div class="summary-list">${items}</div>
    <button class="btn-cta" onclick="playAgain()">Play again</button>
  `);
}

/* DONE */
function done(ok,{reason="",bonuses=[]}={}){
  stopTimer();
  const tB=state.timeLeft>5?"Time bonus":null, mB=uniqCoins()<3&&state.inserted>0?"Change bonus":null;
  if(tB)bonuses.push(tB); if(mB)bonuses.push(mB);

  const before = score;
  score = ok ? score + 10 + bonuses.length*5 : Math.max(0, score-5);
  const delta = score - before;

  /* zapisz do historii i do podsumowania */
  const roundInfo = {round:currentRound, success:ok, reason:reason||(ok?"OK":"Error"), bonuses:[...bonuses], pointsDelta:delta, request:{...state.request}};
  roundSummaries.push(roundInfo);

  state.history.unshift(roundInfo);
  state.history=state.history.slice(0,7);
  updateHud();

  /* feedback -> countdown, a po 5 rundach summary */
  if(currentRound>=TOTAL_ROUNDS){
    showQuickFeedback(ok, delta, roundInfo.reason);
    setTimeout(()=>{ showEndSummary(); }, 1300);
  }else{
    showQuickFeedback(ok, delta, roundInfo.reason);
  }
}

/* AKCJE */
window.addTicket=function(n){
  const req=state.request[n]||0, cur=state.selectedTickets[n]||0;
  if(req>0 && cur>=req) return;
  state.selectedTickets[n]=cur+1; renderTickets(); updateHud(); maybeFinish();
}
window.removeTicket=function(n){
  const cur=state.selectedTickets[n]||0; if(cur<=0) return;
  state.selectedTickets[n]=cur-1; if(state.selectedTickets[n]<=0) delete state.selectedTickets[n];
  renderTickets(); updateHud(); maybeFinish();
}
window.insertCoin=function(v){
  const changeDue=+(state.pays-state.ticketTotal).toFixed(2);
  const next=+(state.inserted+v).toFixed(2);
  if(next-changeDue>0.001){ done(false,{reason:"Too much change"}); return; }
  state.inserted=next;
  state.coinsUsed[v]=(state.coinsUsed[v]||0)+1;
  if(!state.showChange) state.showChange=true;   // reszta odsłania się dopiero teraz
  updateHud(); maybeFinish();
}

$("clearTickets").addEventListener('click', ()=>{
  state.selectedTickets={}; renderTickets(); updateHud();
});

function maybeFinish(){
  const changeDue=+(state.pays-state.ticketTotal).toFixed(2);
  const okMoney=Math.abs(state.inserted-changeDue)<=0.001;
  const okTickets=Object.entries(state.request).every(([n,c])=>(state.selectedTickets[n]||0)===c)
     && Object.keys(state.request).length===Object.keys(state.selectedTickets).length;
  if(okMoney && okTickets){ done(true,{reason:"OK"}) }
}

/* PLAY AGAIN */
window.playAgain=function(){
  // reset
  currentRound=0; score=0; state.history=[]; roundSummaries.length=0;
  hideOverlay(); updateHud(); startRound();
}

/* START */
renderCoins(); updateHud(); startRound();
</script>
</body>
</html>
