<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Ticket Rush — PRO</title>

<!-- iOS fullscreen (PWA) -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/192.png" />
<link rel="manifest" href="manifest.webmanifest" />

<style>
:root{
  color-scheme: dark;
  /* Kolory: neutralne tło + żółty pasek sekcji, wysoki kontrast */
  --bg:#0c111a; --panel:#0f1623; --panel2:#0b1019; --border:#263042;
  --text:#f5f7fb; --muted:#aab6cb; --accent:#ffd22e;
  --ok:#38d987; --bad:#ff4d4d;
  --tile-green:#19b46b; --tile-blue:#3294ff; --tile-orange:#ff8a3d; --tile-purple:#ab7cff;
  --tile-pink:#ff598a; --tile-teal:#27d8d8; --tile-olive:#8bd13c; --tile-red:#ff5b52;
  --coin:#ffd22e; --coinText:#1e2430;

  /* Skala „na kciuk”: baza 720h -> można podbić 840, jeśli chcesz jeszcze większe */
  --baseH: 840px;

  /* Typografia — bardzo duża */
  --h1: 40px; --h2: 28px; --body: 20px; --meta: 16px;
  --tile: 24px; --tileSub: 18px; --chip: 18px;

  --r-lg: 20px; --r-md:14px; --r-sm:10px;
  --pad: 18px; --gap: 16px; --gap2: 20px;
}

/* Reset */
*{box-sizing:border-box}
html{height:100dvh; -webkit-text-size-adjust:100%}
body{
  margin:0; height:100dvh; overflow:hidden; touch-action:manipulation;
  font-family:-apple-system,"SF Pro Text",Inter,system-ui,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 15% -10%, rgba(255,210,46,.12), transparent 60%),
    linear-gradient(#0a0f1a, #0c111a);
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  -webkit-tap-highlight-color:transparent;
}

/* STAGE: pełne centrowanie + skalowanie */
#viewport{position:fixed; inset:0; overflow:hidden}
#stage{
  position:absolute; top:50%; left:50%;
  width:calc(var(--baseH) * (16/9));  /* 16:9, ale liczona z wysokości bazowej */
  height:var(--baseH);
  transform:translate(-50%,-50%) scale(var(--fit,1));
  transform-origin:center center;
}

/* Rama aplikacji: 3 kolumny jak na screenie */
.app{
  width:100%; height:100%;
  display:grid; grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 74px 1fr;
  gap: var(--gap);
  padding: var(--gap);
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:var(--r-lg);
}

/* Pasek sekcji */
.section-title{
  grid-column: 1 / -1;
  display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap);
}
.section-title > div{
  background:var(--accent);
  color:#0d0f14; font-weight:900; letter-spacing:.08em;
  text-align:center; padding:10px 0; border-radius:12px; font-size: var(--h2);
}

/* 3 kolumny */
.col{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--r-lg);
  padding: var(--pad);
  display:grid; grid-template-rows: auto 1fr auto; gap:var(--gap);
}

/* nagłówki wewnętrzne */
.hdr{display:flex; align-items:center; justify-content:space-between}
.hdr h1{margin:0; font-size:var(--h1); letter-spacing:.02em;}

/* karty i siatki */
.card{
  background:#0a121f; border:1px solid var(--border); border-radius:var(--r-md);
  padding: var(--pad);
}
.meta{color:var(--muted); font-size:var(--meta); letter-spacing:.06em; text-transform:uppercase}
.big{font-size:var(--h2); font-weight:900}

.grid4x2{display:grid; gap:var(--gap); grid-template-columns:repeat(2,1fr); grid-auto-rows:minmax(88px,1fr)}
.gridCoins{display:grid; gap:var(--gap); grid-template-columns:repeat(3,1fr); grid-auto-rows: minmax(88px,1fr)}
@media (min-width: 1200px){
  .grid4x2{grid-template-columns:repeat(2,1fr)}
  .gridCoins{grid-template-columns:repeat(3,1fr)}
}

/* Bilety / monety — bardzo duże kafle */
.btn{
  display:grid; place-items:center; text-align:center; user-select:none; cursor:pointer;
  height:100%; padding: 12px;
  border:0; border-radius:16px; color:#fff;
  font-weight:900; font-size:var(--tile); line-height:1.15;
  box-shadow: inset 0 -2px 0 rgba(255,255,255,.2), 0 10px 24px rgba(0,0,0,.28);
  transition:transform .06s ease, filter .12s ease, opacity .2s ease;
  touch-action:manipulation;
}
.btn .sub{font-size:var(--tileSub); font-weight:800; opacity:.95}
.btn .chip{margin-top:6px; font-size:var(--chip); font-weight:800; padding:4px 14px; border-radius:999px;
           background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25)}
.btn:active{transform:translateY(1px) scale(.99); filter:brightness(.98)}
.btn:disabled{opacity:.45; cursor:not-allowed}

/* Palety biletów (mocny, jednolity kolor + subtelny radial) */
.t-normal  { background: radial-gradient(120% 140% at 20% 10%, #26d17e, #19b46b); }
.t-kid     { background: radial-gradient(120% 140% at 20% 10%, #47a8ff, #3294ff); }
.t-luggage { background: radial-gradient(120% 140% at 20% 10%, #ffa867, #ff8a3d); }
.t-senior  { background: radial-gradient(120% 140% at 20% 10%, #c6a8ff, #ab7cff); }
.t-disabled{ background: radial-gradient(120% 140% at 20% 10%, #ff82a7, #ff598a); }
.t-stroller{ background: radial-gradient(120% 140% at 20% 10%, #4fe7e7, #27d8d8); }
.t-bike    { background: radial-gradient(120% 140% at 20% 10%, #a6e85a, #8bd13c); }
.t-tourist { background: radial-gradient(120% 140% at 20% 10%, #ff7a72, #ff5b52); }

/* Monety / banknoty */
.coin { background: radial-gradient(120% 140% at 20% 10%, #ffe478, var(--coin)); color:var(--coinText) }
.bill { background: linear-gradient(180deg, #d5f0cf, #b7e4a8); color:#123b1f; }

/* Sekcja PAYMENT */
.row{display:flex; gap:var(--gap)}
.box{
  flex:1; background:#0a121f; border:2px solid var(--border); border-radius:12px;
  display:flex; align-items:center; justify-content:center; font-weight:900; font-size:var(--h2); padding:16px;
}

/* Historia */
.list{display:grid; gap:12px; max-height: 40vh; overflow:auto}
.item{display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
      border-radius:12px; background:#0a121f; border:1px solid var(--border)}
.badge{font-weight:900; padding:6px 10px; border-radius:999px; border:1px solid #2a3346; color:#d9e3f3}

/* Anty-zoom iOS: min 16px wszędzie – już jest; dodatkowo focus */
.btn:focus-visible{outline:3px solid rgba(255,210,46,.85); outline-offset:2px}
</style>
</head>
<body>
  <div id="viewport">
    <div id="stage">
      <div class="app">
        <!-- Pasek sekcji -->
        <div class="section-title">
          <div>TICKETS</div>
          <div>PAYMENT</div>
          <div>CHANGE</div>
        </div>

        <!-- KOLUMNA 1: TICKETS -->
        <section class="col">
          <div class="card">
            <div class="meta">Passenger needs</div>
            <div class="big" id="need">—</div>
          </div>

          <div class="grid4x2" id="tickets"></div>

          <div class="row">
            <div class="card" style="flex:1">
              <div class="meta">Tickets value</div>
              <div class="big" id="fare">$0.00</div>
            </div>
          </div>
        </section>

        <!-- KOLUMNA 2: PAYMENT (licznik czasu + do zapłaty + Twój wybór) -->
        <section class="col">
          <div class="hdr">
            <h1>⏱ <span id="timer">20 s</span></h1>
            <div class="card">
              <div class="meta">To pay</div>
              <div class="big" id="pays">$0.00</div>
            </div>
          </div>

          <div class="card" style="display:grid; gap:10px">
            <div class="meta">Your choice</div>
            <div class="big" id="choice">—</div>
          </div>

          <div class="row">
            <div class="box">Selected: <span id="picked" style="margin-left:10px">$0.00</span></div>
          </div>
        </section>

        <!-- KOLUMNA 3: CHANGE + KPI + HISTORIA -->
        <section class="col">
          <div class="row">
            <div class="card" style="flex:1">
              <div class="meta">Change given</div>
              <div class="big" id="inserted">$0.00</div>
            </div>
            <div class="card" style="flex:1">
              <div class="meta">Change to give</div>
              <div class="big" id="remain">$0.00</div>
            </div>
          </div>

          <div class="gridCoins" id="coins"></div>

          <div class="card">
            <div class="row">
              <div><div class="meta">Score</div><div class="big" id="score">0</div></div>
              <div><div class="meta">Sales</div><div class="big" id="round">0 / 5</div></div>
              <div><div class="meta">Denoms used</div><div class="big" id="mix">0</div></div>
            </div>
          </div>
        </section>

        <!-- pełna szerokość: Historia -->
        <div class="col" style="grid-column: 1 / -1">
          <div class="meta" style="margin-bottom:6px">History</div>
          <div class="list" id="history"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* No-zoom iOS */
(function(){let t=0;document.addEventListener('touchend',e=>{const n=Date.now();if(n-t<350){e.preventDefault()}t=n},{passive:false});document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false})})();

/* Fit-to-screen: idealne centrowanie + skala */
(function(){
  const stage=document.getElementById('stage');
  function fit(){
    const vv=window.visualViewport||{width:innerWidth,height:innerHeight};
    const vw=vv.width, vh=vv.height;
    const baseH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--baseH'));
    const baseW=baseH*(vw/vh);  // dopasuj do proporcji urządzenia
    stage.style.width=baseW+'px'; stage.style.height=baseH+'px';
    const scale=Math.min(vw/baseW, vh/baseH);
    stage.style.setProperty('--fit', scale);
  }
  addEventListener('resize',fit); addEventListener('orientationchange',()=>setTimeout(fit,60));
  document.fonts?.ready.then(fit); new ResizeObserver(fit).observe(document.getElementById('viewport')); fit();
})();

/* ====== LOGIKA (bez zmian zasad) ====== */
const ticketTypes=[
  {name:"Normal", price:1.2, cls:"t-normal"},
  {name:"Kid", price:0.5, cls:"t-kid"},
  {name:"Luggage", price:0.6, cls:"t-luggage"},
  {name:"Senior", price:0.8, cls:"t-senior"},
  {name:"Disabled", price:0.6, cls:"t-disabled"},
  {name:"Baby Stroller", price:0.7, cls:"t-stroller"},
  {name:"Bike", price:0.9, cls:"t-bike"},
  {name:"Tourist", price:1.5, cls:"t-tourist"}
];
const coins=[5,2,1,0.5,0.25,0.1,0.05,0.01];

const $=id=>document.getElementById(id);
const timerDisplay=$("timer"), scoreDisplay=$("score"), roundDisplay=$("round"),
      historyList=$("history"), needEl=$("need"), paysEl=$("pays"), fareEl=$("fare"),
      pickedEl=$("picked"), choiceEl=$("choice"),
      insertedEl=$("inserted"), remainEl=$("remain"), mixEl=$("mix"),
      ticketsWrap=$("tickets"), coinsWrap=$("coins");

const TOTAL_ROUNDS=5; let currentRound=0, score=0, timerId=null;
const state={request:{}, ticketTotal:0, pays:0, selectedTickets:{}, coinsUsed:{}, inserted:0, timeLeft:20, history:[]};

const rndReq=()=>{const out={}, uniq=Math.floor(Math.random()*2)+1, pool=[...ticketTypes];
  for(let i=0;i<uniq;i++){const pick=Math.floor(Math.random()*Math.min(3+currentRound,pool.length));
    const [t]=pool.splice(pick,1); const cnt=Math.floor(Math.random()*3)+1; out[t.name]=cnt;}
  return out};
const calcFare=req=>Object.entries(req).reduce((s,[n,c])=>{const t=ticketTypes.find(x=>x.name===n); return s+(t?t.price*c:0)},0);
const uniqCoins=()=>Object.keys(state.coinsUsed).filter(k=>state.coinsUsed[k]>0).length;

function render(){
  // bilety
  ticketsWrap.innerHTML = ticketTypes.map(t=>{
    const count=state.selectedTickets[t.name]||0, need=state.request[t.name]||0;
    const dis = need>0 && count>=need;
    return `<button class="btn ${t.cls}" ${dis?'disabled':''}
              onclick="addTicket('${t.name}')" oncontextmenu="event.preventDefault(); removeTicket('${t.name}')">
              <div class="sub">${t.name}</div>
              <div>$${t.price.toFixed(2)}</div>
              <div class="chip">${count} / ${need||0}</div>
            </button>`;
  }).join("");

  // monety
  coinsWrap.innerHTML = coins.map(v=>`
    <button class="btn coin" onclick="insertCoin(${v})">
      <div class="sub">Coin</div>
      <div>$${v.toFixed(2)}</div>
      <div class="chip">×${state.coinsUsed[v]||0}</div>
    </button>
  `).join("");
}

function updateHud(){
  scoreDisplay.textContent=score; roundDisplay.textContent=`${Math.min(currentRound,TOTAL_ROUNDS)} / ${TOTAL_ROUNDS}`;
  historyList.innerHTML = state.history.map(({round:r,success,reason,bonuses})=>
    `<div class="item"><span><strong>Round ${r}</strong> ${success?'✅':'❌'} ${reason}</span>${bonuses.length?`<span class="badge">${bonuses.join(' • ')}</span>`:''}</div>`
  ).join("");

  needEl.textContent = Object.entries(state.request).map(([n,c])=>`${c}× ${n}`).join(", ");
  paysEl.textContent = `$${state.pays.toFixed(2)}`;
  fareEl.textContent = `$${state.ticketTotal.toFixed(2)}`;

  const selectedValue=Object.entries(state.selectedTickets).reduce((s,[n,c])=>{
    const t=ticketTypes.find(x=>x.name===n); return s+(t?t.price*c:0);
  },0);
  pickedEl.textContent = `$${selectedValue.toFixed(2)}`;
  choiceEl.textContent = Object.entries(state.selectedTickets).map(([n,c])=>`${c}× ${n}`).join(", ") || "—";

  insertedEl.textContent = `$${state.inserted.toFixed(2)}`;
  const changeDue=+(state.pays-state.ticketTotal).toFixed(2);
  const remaining=+(changeDue-state.inserted).toFixed(2);
  remainEl.textContent = `$${Math.max(remaining,0).toFixed(2)}`;
  mixEl.textContent = uniqCoins();
}

function startRound(){
  currentRound+=1; if(currentRound> TOTAL_ROUNDS){summary(); return;}
  Object.assign(state,{request:rndReq(), selectedTickets:{}, coinsUsed:{}, inserted:0, timeLeft:20});
  state.ticketTotal=+calcFare(state.request).toFixed(2);
  const extra=[0.5,1,1.5,2,2.5][Math.floor(Math.random()*5)];
  state.pays=+(state.ticketTotal+extra).toFixed(2);
  render(); updateHud(); tick();
}
function tick(){ stop(); timerDisplay.textContent=`${state.timeLeft} s`;
  timerId=setInterval(()=>{state.timeLeft--; if(state.timeLeft<=0){timerDisplay.textContent='0 s'; stop(); done(false,{reason:"Time up"});return}
  timerDisplay.textContent=`${state.timeLeft} s`},1000)}
function stop(){ if(timerId){clearInterval(timerId); timerId=null} }
function done(ok,{reason="",bonuses=[]}={}){ stop();
  const tB=state.timeLeft>5?"Time bonus":null, mB=uniqCoins()<3&&state.inserted>0?"Change bonus":null;
  if(tB)bonuses.push(tB); if(mB)bonuses.push(mB);
  score = ok ? score + 10 + bonuses.length*5 : Math.max(0, score-5);
  state.history.unshift({round:currentRound, success:ok, reason:reason||(ok?"Good sale":"Error"), bonuses});
  state.history=state.history.slice(0,6);
  updateHud(); if(currentRound>=TOTAL_ROUNDS) setTimeout(summary,800); else setTimeout(startRound,800);
}
function summary(){ state.history.unshift({round:"—", success:true, reason:`Shift end. Score: ${score}`, bonuses:[]}); updateHud(); }

window.addTicket=function(n){const req=state.request[n]||0, cur=state.selectedTickets[n]||0; if(cur>=req&&req>0)return;
  state.selectedTickets[n]=cur+1; updateHud(); auto();}
window.removeTicket=function(n){const cur=state.selectedTickets[n]||0; if(cur<=0)return;
  state.selectedTickets[n]=cur-1; if(state.selectedTickets[n]<=0) delete state.selectedTickets[n]; updateHud(); auto();}
window.insertCoin=function(v){const need=+(state.pays-state.ticketTotal).toFixed(2), next=+(state.inserted+v).toFixed(2);
  if(next-need>0.001){done(false,{reason:"Too much change"}); return}
  state.inserted=next; state.coinsUsed[v]=(state.coinsUsed[v]||0)+1; updateHud(); auto();}
function auto(){const need=+(state.pays-state.ticketTotal).toFixed(2);
  const okMoney=Math.abs(state.inserted-need)<=0.001;
  const okTickets=Object.entries(state.request).every(([n,c])=>(state.selectedTickets[n]||0)===c)
    && Object.keys(state.request).length===Object.keys(state.selectedTickets).length;
  if(okMoney&&okTickets) done(true,{reason:"OK"});}

updateHud(); startRound();
</script>
</body>
</html>
